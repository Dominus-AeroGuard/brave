datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

enum UserStatus {
  ACTIVE
  INACTIVE
  INVITED
}

model User {
  user_id       Int                       @id @default(autoincrement())
  name          String                    @db.VarChar(100)
  email         String                    @db.VarChar(100)
  document      String                    @db.VarChar(14)
  status        UserStatus                @default(INVITED)
  created_at    DateTime                  @default(now())
  applications  Application[]
  organizations UserOrganization[]
  notifications ApplicationNotification[]

  @@map("user")
}

model Organization {
  organization_id Int                @id @default(autoincrement())
  name            String             @db.VarChar(100)
  created_at      DateTime           @default(now())
  pilots          Pilot[]
  applications    Application[]
  users           UserOrganization[]
  protected_areas ProtectedArea[]

  @@map("organization")
}

model UserOrganization {
  user_id         Int
  organization_id Int
  active          Boolean      @default(true)
  updated_by      String
  created_by      String
  updated_at      DateTime     @default(now())
  organization    Organization @relation(fields: [organization_id], references: [organization_id])
  user            User         @relation(fields: [user_id], references: [user_id])
  created_at      DateTime     @default(now())

  @@id([user_id, organization_id])
  @@map("user_organization")
}

model Pilot {
  pilot_id        Int                @id @default(autoincrement())
  organization_id Int
  name            String             @db.VarChar(100)
  document        String             @db.VarChar(14)
  license         String             @db.VarChar(20)
  created_at      DateTime           @default(now())
  organization    Organization       @relation(fields: [organization_id], references: [organization_id])
  events          ApplicationEvent[]

  @@map("pilot")
}

model Application {
  application_id          BigInt                    @id @default(autoincrement()) @db.BigInt
  user_id                 Int
  organization_id         Int
  vehicle                 String                    @db.VarChar(100)
  start_date              DateTime
  end_date                DateTime
  created_by              String                    @db.VarChar(100)
  created_at              DateTime                  @default(now())
  user                    User                      @relation(fields: [user_id], references: [user_id])
  organization            Organization              @relation(fields: [organization_id], references: [organization_id])
  events                  ApplicationEvent[]
  documents               ApplicationDocument[]
  areas                   ApplicationArea[]
  paths                   ApplicationPath[]
  analisys                ApplicationAnalisys[]
  ApplicationNotification ApplicationNotification[]

  @@index([user_id, created_at(sort: Desc)])
  @@map("application")
}

model ApplicationEvent {
  application_event_id  BigInt            @id @default(autoincrement()) @db.BigInt
  application_id        BigInt            @db.BigInt
  application_status_id Int
  pilot_id              Int
  created_by            String
  created_at            DateTime          @default(now())
  application           Application       @relation(fields: [application_id], references: [application_id])
  status                ApplicationStatus @relation(fields: [application_status_id], references: [application_status_id])
  pilot                 Pilot             @relation(fields: [pilot_id], references: [pilot_id])

  @@index([application_id, created_at(sort: Desc)])
  @@map("application_event")
}

model ApplicationStatus {
  application_status_id Int                @id @default(autoincrement())
  description           String             @db.VarChar(100)
  active                Boolean
  created_at            DateTime           @default(now())
  events                ApplicationEvent[]

  @@map("application_status")
}

model ApplicationDocument {
  application_document_id      Int                       @id @default(autoincrement())
  application_id               BigInt                    @db.BigInt
  application_document_type_id Int
  original_name                String                    @db.VarChar(200)
  path                         String                    @db.VarChar(1000)
  application                  Application               @relation(fields: [application_id], references: [application_id])
  type                         ApplicationDocumentType   @relation(fields: [application_document_type_id], references: [application_document_type_id])
  data                         ApplicationDocumentData[]

  @@map("application_document")
}

model ApplicationDocumentData {
  id          BigInt              @id @default(autoincrement())
  document_id Int
  key         String              @db.VarChar(100)
  value       String?             @db.VarChar(200)
  revision    Int                 @default(1)
  created_by  Int
  created_at  DateTime            @default(now())
  document    ApplicationDocument @relation(fields: [document_id], references: [application_document_id])

  @@map("application_document_data")
}

model ApplicationDocumentType {
  application_document_type_id Int                   @id @default(autoincrement())
  description                  String                @db.VarChar(100)
  active                       Boolean
  created_at                   DateTime              @default(now())
  documents                    ApplicationDocument[]

  @@map("application_document_type")
}

model ApplicationArea {
  id             Int                                            @id @default(autoincrement())
  geom           Unsupported("public.geometry(polygonz, 4326)")
  geomjson       String
  description    String                                         @db.VarChar(100)
  application_id BigInt                                         @db.BigInt
  application    Application                                    @relation(fields: [application_id], references: [application_id])
  created_at     DateTime                                       @default(now())

  @@index([geom], name: "application_area_idx", type: Gist)
  @@map("application_area")
}

enum ApplicationAnalisysStatus {
  PENDING
  APPROVED
  FAILED
  REJECTED
}

model ApplicationAnalisys {
  application_analisys_id      Int                       @id @default(autoincrement())
  application_analisys_type_id Int
  application_id               BigInt                    @db.BigInt
  application_notification_id  BigInt?                   @db.BigInt
  elapsed_time                 Int
  status                       ApplicationAnalisysStatus @default(PENDING)
  details                      Json?
  created_at                   DateTime                  @default(now())
  application                  Application               @relation(fields: [application_id], references: [application_id])
  type                         ApplicationAnalisysType   @relation(fields: [application_analisys_type_id], references: [application_analisys_type_id])
  ApplicationNotification      ApplicationNotification?  @relation(fields: [application_notification_id], references: [application_notification_id])

  @@map("application_analisys")
}

model ApplicationAnalisysType {
  application_analisys_type_id Int                   @id @default(autoincrement())
  name                         String                @db.VarChar(100)
  allow_reprocess              Boolean               @default(true)
  active                       Boolean               @default(true)
  created_at                   DateTime              @default(now())
  applicationAnalisys          ApplicationAnalisys[]

  @@map("application_analisys_type")
}

enum NotificationAlertLevel {
  GRAVISSIMO
  GRAVE
  MODERADO
  LEVE
}

model ApplicationNotification {
  application_notification_id BigInt                         @id @default(autoincrement())
  application_id              BigInt                         @db.BigInt
  created_at                  DateTime                       @default(now())
  fiscal_id                   Int
  alert_level                 NotificationAlertLevel         @default(LEVE)
  application                 Application                    @relation(fields: [application_id], references: [application_id])
  fiscal                      User                           @relation(fields: [fiscal_id], references: [user_id])
  analisys                    ApplicationAnalisys[]
  events                      ApplicationNotificationEvent[]

  @@map("application_notification")
}

model ApplicationNotificationEvent {
  event_id                           BigInt                        @id @default(autoincrement()) @db.BigInt
  application_notification_id        BigInt                        @db.BigInt
  application_notification_status_id Int
  created_by                         String
  created_at                         DateTime                      @default(now())
  status                             ApplicationNotificationStatus @relation(fields: [application_notification_status_id], references: [id])
  notification                       ApplicationNotification       @relation(fields: [application_notification_id], references: [application_notification_id])

  @@map("application_notification_event")
}

model ApplicationNotificationStatus {
  id            Int                            @id @default(autoincrement())
  description   String                         @db.VarChar(100)
  active        Boolean                        @default(true)
  created_at    DateTime                       @default(now())
  notifications ApplicationNotificationEvent[]

  @@map("application_notification_status")
}

model ProtectedArea {
  id                     Int                                            @id @default(autoincrement())
  geom                   Unsupported("public.geometry(polygonz, 4326)")
  geomjson               String
  description            String                                         @db.VarChar(100)
  protected_area_type_id Int
  type                   ProtectedAreaType                              @relation(fields: [protected_area_type_id], references: [protected_area_type_id])
  organization_id        Int
  organization           Organization                                   @relation(fields: [organization_id], references: [organization_id])
  created_by             String
  created_at             DateTime                                       @default(now())

  @@index([geom], name: "protected_area_idx", type: Gist)
  @@map("protected_area")
}

model ProtectedAreaType {
  protected_area_type_id Int             @id @default(autoincrement())
  name                   String          @db.VarChar(100)
  description            String          @db.VarChar(1000)
  distance               Int
  distance_drone         Int
  active                 Boolean         @default(true)
  created_at             DateTime        @default(now())
  protected_area         ProtectedArea[]

  @@map("protected_area_type")
}

model ApplicationPath {
  id             Int                                            @id @default(autoincrement())
  geom           Unsupported("public.geometry(linestringz, 4326)")
  geomjson       String
  description    String                                         @db.VarChar(100)
  application_id BigInt                                         @db.BigInt
  application    Application                                    @relation(fields: [application_id], references: [application_id])
  created_at     DateTime                                       @default(now())

  @@index([geom], name: "application_path_idx", type: Gist)
  @@map("application_path")
}
